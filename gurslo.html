<head>
  <link rel="stylesheet" href="gurslo.css">
</head>
<div class="main sheet-main">

<!-- LOGO SECTION -->
  <div class="sheet-logo logo section"> 
    <span> Logo Gurslo RPG</span> 
  </div>

<!-- NAME SECTION -->

  <div class="sheet-name name section">
    <div class="sheet-section-small flex-center">
      <input name="attr_nome_personagem" type="text">
      <label>NOME</label>
    </div>
    <div class="sheet-section-small flex-center">
      <input name="attr_classe" type="text">
      <label>CLASSE</label>
    </div>   
    <div class="sheet-section-small flex-center">
      <input name="attr_raca" type="text">
      <label>RAÇA</label>
    </div>   

    <div class="sheet-section-small flex-center">
      <input name="attr_nivel"       type="number" value="1">
      <label>NÍVEL</label>
    </div>
  
    <div class="sheet-section-small flex-center">
      <input name="attr_xp"       type="number" value="0">
      <label>EXP</label>
    </div>
  </div>

<!-- MAIN STAT SECTION -->

  <div class="sheet-stats section">
    <div class="sheet-stat-block flex-center">
      <label>FORÇA</label>
      <div class="sheet-stats-inputs">
      <input name="attr_forca" type="number" value="1">
      <span name="attr_forca_bonus"></span>
      <button type="roll" value="&{template:custom} {{title=Teste de Força}}{{subtitle=@{nome_personagem}}} {{Teste=[[@{rollforca}]]}}" name="roll_forca"></button>
      <input type="hidden" name="attr_rollforca" value="1d4">
    </div>
    </div>   

    <div class="sheet-stat-block flex-center">
      <label>DESTREZA</label>
      <div class="sheet-stats-inputs">
      <input name="attr_destreza" type="number" value="1">
      <span name="attr_destreza_bonus"></span>
      <button type="roll" value="&{template:custom} {{title=Teste de Destreza}}{{subtitle=@{nome_personagem}}} {{Teste=[[@{rolldestreza}]]}}" name="roll_destreza"></button>
      <input type="hidden" name="attr_rolldestreza" value="1d4">
    </div>
    </div>

    <div class="sheet-stat-block flex-center">
        <label>INTELIGÊNCIA</label>
        <div class="sheet-stats-inputs">
        <input name="attr_inteligencia" type="number" value="1">
        <span name="attr_inteligencia_bonus"></span>
        <button type="roll" value="&{template:custom} {{title=Teste de Inteligência}}{{subtitle=@{nome_personagem}}} {{Teste=[[@{rollinteligencia}]]}}" name="roll_inteligencia"></button>
      <input type="hidden" name="attr_rollinteligencia" value="1d4">
    </div>
      </div>

    <div class="sheet-stat-block flex-center">
      <label>CONSTITUIÇÃO</label>
      <div class="sheet-stats-inputs">
      <input name="attr_constituicao" type="number" value="1">
      <span name="attr_constituicao_bonus"></span>
      <button type="roll" value="&{template:custom} {{title=Teste de Constituição}}{{subtitle=@{nome_personagem}}} {{Teste=[[@{rollconstituicao}]]}}" name="roll_constituicao"></button>
      <input type="hidden" name="attr_rollconstituicao" value="1d4">
    </div>
    </div>

    <div class="sheet-stat-block flex-center">
      <label>CARISMA</label>
      <div class="sheet-stats-inputs">
      <input name="attr_carisma" type="number" value="1">
      <span name="attr_carisma_bonus"></span>
      <button type="roll" value="&{template:custom} {{title=Teste de Carisma}}{{subtitle=@{nome_personagem}}} {{Teste=[[@{rollcarisma}]]}}" name="roll_carisma"></button>
      <input type="hidden" name="attr_rollcarisma" value="1d4">
    </div>
    </div>

    <!-- BIO SECTION -->
  <div class="sheet-bio section flex-center flex-middle flex-down">
    <label>Bio</label>
    <div class="sheet-bio-text">
    <textarea  name="attr_bio" placeholder="Bio"></textarea>
  </div>
  </div>

  <!-- LOAD SECTION -->
  <div class="sheet-load section flex-center flex-middle flex-down">
    <label>Equipamentos</label>
    <div>
    <span>
      <input name="attr_arma1_nome" type="text" placeholder="Nome Arma"> 
      <input name="attr_arma1_bonus" type="number" value="0"> 
      <input name="attr_arma1_dado" type="text" value="1d4" class="small">
      <select name="attr_arma1_atrib">
        <option value="0" selected="selected">Força</option>
        <option value="1">Destreza</option>
        <option value="2">Inteligência</option>
      </select> 
      <button name="roll_arma1" type="roll" value="&{template:custom} {{title=@{arma1_nome}}}{{subtitle=@{nome_personagem}}} {{Dano Total=[[@{danototalarma1}]]}}" class ="small"></button>
      <input type="hidden" name="attr_danototalarma1" value="@{arma1_atrib_roll} + @{arma1_bonus} + @{arma1_dado}">
      <input type="hidden" name="attr_arma1_atrib_roll" value="0">
    </span>
  </div>
  <div>
    <span>
      <input name="attr_arma2_nome" type="text" placeholder="Nome Arma"> 
      <input name="attr_arma2_bonus" type="number" value="0"> 
      <input name="attr_arma2_dado" type="text" value="1d4" class="small">
      <select name="attr_arma2_atrib">
        <option value="0" selected="selected">Força</option>
        <option value="1">Destreza</option>
        <option value="2">Inteligência</option>
      </select> 
      <button name="roll_arma2" type="roll" value="&{template:custom} {{title=@{arma2_nome}}}{{subtitle=@{nome_personagem}}} {{Dano Total=[[@{danototalarma2}]]}}" class ="small"></button>
      <input type="hidden" name="attr_danototalarma2" value="@{arma1_atrib_roll} + @{arma2_bonus} + @{arma2_dado}">
      <input type="hidden" name="attr_arma2_atrib_roll" value="0">
    </span>
  </div>
  <div class="sheet-gold section flex-center" style="justify-content: space-evenly;">
    <label style="padding-top: 5px;">Ouro:</label>
    <input name="attr_ouro" type="number" value="0">
  </div>
  <div class="sheet-load-text">
    <textarea name="attr_carga" placeholder="Carga"></textarea>
  </div>
  </div>


  </div>

<!-- ATTR SECTION -->
<div class="sheet-attr section">
  <div class="sheet-attr-block flex-center">
    <div>
      <input name="attr_vida"       type="number" value="0">/
      <input name="attr_vida_max" type="number" value="0">
    </div>
    <label>VIDA</label>
  </div>

  <div class="sheet-attr-block flex-center">
    <div>
      <input name="attr_mana"     type="number" value="0">/
      <input name="attr_mana_max" type="number" value="0">
    </div>
    <label>MANA</label>
  </div>

  <div class="sheet-attr-block flex-center">
    <div>
      <input name="attr_vigor"     type="number" value="0">/
      <input name="attr_vigor_max" type="number" value="0">
    </div>
    <label>VIGOR</label>
    </div>

  <div class="sheet-attr-block flex-center">
    <div>
      <input name="attr_armadura" type="number" value="0">
      <input type="hidden" name="attr_rollarmadura" value="0">
    </div>
    <label>ARM</label>
  </div>

  <div class="sheet-attr-block flex-center">
    <div>
      <input name="attr_esquiva"     type="number" value="0">
      <input type="hidden" name="attr_rollesquiva" value="1d4">
    </div>
    <label>ESQ</label>
    </div>

  <div class="sheet-attr-block flex-center">
    <div>
      <input name="attr_tenacidade" type="number" value="0">
    </div>
    <label>TEN</label>
  </div>  
</div>

<!-- Iniciativa/Defesa -->

<div class="sheet-init">
  <div>
    <button name="roll_init" type="roll" value="&{template:custom} {{title=Iniciativa}}}{{subtitle=@{nome_personagem}}}{{Resultado=[[@{rolldestreza}]]}} &{tracker}"></button>
      <span>Iniciativa</span>
  </div>
  <div>
      <button name="roll_defesa" type="roll" value="&{template:custom} {{title=Defesa}}}{{subtitle=@{nome_personagem}}} {{Resultado=[[@{rollesquiva} + @{tenacidade} + @{rollarmadura}]]}}"></button>
      <span>Defesa</span>
  </div>
</div>



<!-- SKILL SECTION -->
  <div class="sheet-order-skills section flex-center flex-down">
    <div class="sheet-order-skills-skill">
      <div class="sheet-order-skills-info">
        <input name="attr_hab1_nome" type="text" placeholder="Nome H1">
        <input name="attr_hab1_custo" type="text" value="[[1]] Mana">
        <button name="roll_h1" type="roll" value="&{template:custom} {{title=@{hab1_nome}}}{{subtitle=@{nome_personagem}}} @{hab1_dados}{{Custo=@{hab1_custo}}}" class ="small"></button> 
      </div>
      <textarea name="attr_hab1_dados">{{desc=Descrição}}{{Caracteristica1=Valor1}}{{Caracteristica2=Valor2}}</textarea>
    </div>
    <div class="sheet-order-skills-skill">
      <div class="sheet-order-skills-info">
        <input name="attr_hab2_nome" type="text" placeholder="Nome H2">
        <input name="attr_hab2_custo" type="text" value="[[1]] Mana">
        <button name="roll_h2" type="roll" value="&{template:custom} {{title=@{hab2_nome}}}{{subtitle=@{nome_personagem}}} @{hab2_dados}{{Custo=@{hab2_custo}}}" class ="small"></button> 
      </div>
      <textarea name="attr_hab2_dados">{{desc=Descrição}}{{Caracteristica1=Valor1}}{{Caracteristica2=Valor2}}</textarea>
    </div>
    <div class="sheet-order-skills-skill">
      <div class="sheet-order-skills-info">
        <input name="attr_hab3_nome" type="text" placeholder="Nome H3">
        <input name="attr_hab3_custo" type="text" value="[[1]] Mana">
        <button name="roll_h3" type="roll" value="&{template:custom} {{title=@{hab3_nome}}}{{subtitle=@{nome_personagem}}} @{hab3_dados}{{Custo=@{hab3_custo}}}" class ="small"></button> 
      </div>
      <textarea name="attr_hab3_dados">{{desc=Descrição}}{{Caracteristica1=Valor1}}{{Caracteristica2=Valor2}}</textarea>
    </div>
    <div class="sheet-order-skills-skill">
      <div class="sheet-order-skills-info">
        <input name="attr_hab4_nome" type="text" placeholder="Nome H4">
        <input name="attr_hab4_custo" type="text" value="[[1]] Mana">
        <button name="roll_h4" type="roll" value="&{template:custom} {{title=@{hab4_nome}}}{{subtitle=@{nome_personagem}}} @{hab4_dados}{{Custo=@{hab4_custo}}}" class ="small"></button> 
      </div>
      <textarea name="attr_hab4_dados">{{desc=Descrição}}{{Caracteristica1=Valor1}}{{Caracteristica2=Valor2}}</textarea>
    </div>
  </div>

</div>

<input name="attr_forca_bonus" type="hidden" value="0">
<input name="attr_inteligencia_bonus" type="hidden" value="0">
<input name="attr_destreza_bonus" type="hidden" value="0">
<input name="attr_constituicao_bonus" type="hidden" value="0">
<input name="attr_carisma_bonus" type="hidden" value="0">

<!-- ROLL TEMPLATE -->

<rolltemplate class="sheet-rolltemplate-custom">
  <div class="sheet-container sheet-color-{{color}}">
    <div class="sheet-header">
      {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
      {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
    </div>
    <div class="sheet-content">
      {{#allprops() title subtitle desc color}}
      <div class="sheet-key">{{key}}</div>
      <div class="sheet-value">{{value}}</div>
      {{/allprops() title subtitle desc color}}
      {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
    </div>
  </div>
</rolltemplate>

<!-- ---------------------------SHEET WORKERS----------------- -->

<script type="text/worker">

const int = score => parseInt(score, 10) || 0;

function stat2dice(stat_base){
    let dado1 = Math.floor(stat_base/5);
    let dado2 = (stat_base % 5)*2 + 2;
    let stat_bonus = "";
    if (dado2 > 2) stat_bonus = "1d"+dado2.toString();
    if (dado1 > 0) {
        if (dado2 == 2) {
        stat_bonus = dado1.toString() +"d12";
        }
        else {
        stat_bonus = stat_bonus + " + " + dado1.toString() +"d12";
        }
    }
    return stat_bonus;
}

// Calcula automaticamente o valor do dado associado ao atributo

const stats = ["forca", "destreza", "inteligencia", "constituicao", "carisma"];
stats.forEach(stat => {
    on(`change:${stat}`, () => {
        getAttrs([stat], values => {
            const stat_base = int(values[stat]);
            let stat_bonus = stat2dice(stat_base);
   
            setAttrs({
                [`${stat}_bonus`]: stat_bonus,
                [`roll${stat}`]: stat_bonus
            });
        });

        getAttrs(["forca","destreza","inteligencia","constituicao","nivel"], function(values) {
            let forc = parseInt(values.forca, 10);
            let des = parseInt(values.destreza, 10);
            let inte = parseInt(values.inteligencia, 10);
            let con = parseInt(values.constituicao, 10);
            let lvl = parseInt(values.nivel, 10);

            let esquiva = Math.ceil(des/2);
            let vida_max = con*2 + 2;
            let mana_max = con+inte;
            let vigor_max = con+forc;
            let tenacidade = Math.ceil(lvl/2);

            let esquivaRoll = stat2dice(esquiva);


            setAttrs({
                esquiva: esquiva,
                vida_max: vida_max,
                vigor_max: vigor_max,
                mana_max: mana_max,
                tenacidade: tenacidade,
                rollesquiva: esquivaRoll
            });
        });
    });
});

const statsArma = ["arma1", "arma2"];
statsArma.forEach(stat => {
  on(`change:${stat}_atrib`, () => {
    let rollarma = 0;
    getAttrs([`${stat}_atrib`], function(values) {
      rollarma = parseInt(values[`${stat}_atrib`], 10);
    });
    getAttrs(["forca","destreza","inteligencia"], function(values) {
      let forc = parseInt(values.forca, 10);
      let des = parseInt(values.destreza, 10);
      let inte = parseInt(values.inteligencia, 10);
      let textrollarma = "";

      switch(rollarma){
        case 0:
          textrollarma = stat2dice(forc);
          break;
        case 1:
          textrollarma = stat2dice(des);
          break;
        case 2:
          textrollarma = stat2dice(inte);
          break;
      }
      setAttrs({
        [`${stat}_atrib_roll`]: textrollarma
      });
    });
  });  
});

on("change:armadura", function() {  
  getAttrs(["armadura"], function(values) {
      let armadura = parseInt(values.armadura, 10);
      setAttrs({
        rollarmadura: stat2dice(armadura)
      });
  });

});
</script>